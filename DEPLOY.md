# 🚀 Гайд по автодеплою Хачапури Марико

## Особенности системы

Наша система учитывает, что **Cloudflare Tunnel бесплатно генерирует новый URL при каждом перезапуске**. Поэтому создана автоматическая система синхронизации URL между туннелем и ботом.

## Что происходит автоматически

1. **🌐 Динамический туннель** - при каждом деплое запускается новый туннель с новым URL
2. **🤖 Автообновление бота** - URL автоматически обновляется в конфигурации бота  
3. **🔄 Мониторинг** - система следит за изменениями URL и синхронизирует их
4. **📊 Автозапуск** - все сервисы запускаются автоматически при перезагрузке сервера

## Быстрый старт

### 1. Настройка переменных окружения

```bash
# Экспортируем токен бота (получите от @BotFather)
export BOT_TOKEN="ваш_токен_бота"
```

### 2. Полный автодеплой

```bash
# Запускаем автодеплой (фронтенд + бот + туннель + мониторинг)
chmod +x auto-deploy.sh
./auto-deploy.sh
```

Скрипт автоматически:
- ✅ Соберет фронтенд
- ✅ Задеплоит на сервер
- ✅ Запустит новый туннель
- ✅ Получит новый URL
- ✅ Обновит конфигурацию бота
- ✅ Запустит мониторинг изменений URL
- ✅ Настроит автозапуск

## Проверка статуса

```bash
# Проверить статус всей системы
chmod +x tunnel-status.sh
./tunnel-status.sh
```

## Полезные команды

### На локальной машине:
```bash
# Проверка статуса
./tunnel-status.sh

# Полный передеплой
./auto-deploy.sh
```

### На сервере:
```bash
# Статус всех процессов
ssh root@85.198.83.72 "pm2 list"

# Логи бота
ssh root@85.198.83.72 "pm2 logs hachapuri-bot"

# Логи мониторинга туннеля
ssh root@85.198.83.72 "tail -f /tmp/tunnel-monitor.log"

# Текущий URL туннеля
ssh root@85.198.83.72 "grep https /tmp/cloudflared.log | tail -1"

# Перезапуск бота
ssh root@85.198.83.72 "pm2 restart hachapuri-bot"

# Перезапуск туннеля (новый URL!)
ssh root@85.198.83.72 "pm2 restart tunnel-monitor"
```

## Архитектура системы

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Ваш GitHub    │    │    Ваш комп      │    │    Сервер       │
│                 │    │                  │    │                 │
│ ┌─────────────┐ │    │ ┌──────────────┐ │    │ ┌─────────────┐ │
│ │   Код       │ │────┤ │ auto-deploy  │ │────┤ │  Frontend   │ │
│ │  проекта    │ │    │ │    script    │ │    │ │    dist/    │ │
│ └─────────────┘ │    │ └──────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └──────────────────┘    │ ┌─────────────┐ │
                                               │ │ Telegram    │ │
┌─────────────────┐    ┌──────────────────┐    │ │    Bot      │ │
│ Cloudflare      │    │   Мониторинг     │    │ └─────────────┘ │
│   Tunnel        │◄───┤     URL          │◄───┤ ┌─────────────┐ │
│ (новый URL      │    │  (автообновл.)   │    │ │  Cloudflare │ │
│  каждый раз)    │    │                  │    │ │   Tunnel    │ │
└─────────────────┘    └──────────────────┘    │ └─────────────┘ │
                                               └─────────────────┘
```

## Процессы на сервере

После деплоя на сервере будут запущены:

1. **`hachapuri-bot`** - Telegram бот
2. **`tunnel-monitor`** - мониторинг изменений URL туннеля
3. **`cloudflared`** - процесс туннеля (не в PM2, отдельный процесс)
4. **`nginx`** - веб-сервер для статических файлов

## Что делать при проблемах

### Бот не отвечает
```bash
# Проверяем статус
./tunnel-status.sh

# Перезапускаем бота
ssh root@85.198.83.72 "pm2 restart hachapuri-bot"
```

### URL не синхронизируется
```bash
# Проверяем мониторинг
ssh root@85.198.83.72 "pm2 logs tunnel-monitor"

# Перезапускаем мониторинг
ssh root@85.198.83.72 "pm2 restart tunnel-monitor"
```

### Туннель не работает
```bash
# Полный передеплой (создаст новый туннель)
./auto-deploy.sh
```

## Мониторинг

Система ведет логи:
- `/tmp/tunnel-monitor.log` - логи мониторинга URL
- PM2 логи для каждого процесса
- `/tmp/cloudflared.log` - логи туннеля

## Безопасность

- Токен бота храним в переменных окружения
- Доступ к серверу по SSH ключам
- Автоматическое обновление без ручного вмешательства 