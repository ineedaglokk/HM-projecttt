#!/bin/bash

# üîç –°–∫—Ä–∏–ø—Ç –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
# –•–∞—á–∞–ø—É—Ä–∏ –ú–∞—Ä–∏–∫–æ - Telegram Mini App

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º - –•–∞—á–∞–ø—É—Ä–∏ –ú–∞—Ä–∏–∫–æ"
echo "============================================"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$(dirname "$0")/.."

# –°—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
ERRORS=0

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    echo "‚ùå –§–∞–π–ª package.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
if [ ! -d "node_modules" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    npm install
fi

echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º TypeScript –æ—à–∏–±–∫–∏..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
    echo "‚ùå –ù–∞–π–¥–µ–Ω—ã TypeScript –æ—à–∏–±–∫–∏"
    ERRORS=$((ERRORS + 1))
else
    echo "‚úÖ TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞"
fi

echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–Ω—Ç–µ—Ä..."
npm run lint 2>/dev/null
if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ª–∏–Ω—Ç–µ—Ä–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"
else
    echo "‚úÖ –õ–∏–Ω—Ç–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞"
fi

echo "4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    ERRORS=$((ERRORS + 1))
else
    echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è"
fi

echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –±–∞–Ω–¥–ª–∞..."
if [ -d "dist" ]; then
    BUNDLE_SIZE=$(du -sh dist | cut -f1)
    echo "üì¶ –†–∞–∑–º–µ—Ä –±–∞–Ω–¥–ª–∞: $BUNDLE_SIZE"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ main JS —Ñ–∞–π–ª –Ω–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–±–æ–ª—å—à–µ 1MB)
    JS_SIZE=$(find dist -name "*.js" -exec du -k {} + | awk '{sum+=$1} END {print sum}')
    if [ $JS_SIZE -gt 1024 ]; then
        echo "‚ö†Ô∏è  JS –±–∞–Ω–¥–ª –¥–æ–≤–æ–ª—å–Ω–æ –±–æ–ª—å—à–æ–π: ${JS_SIZE}KB"
    else
        echo "‚úÖ –†–∞–∑–º–µ—Ä JS –±–∞–Ω–¥–ª–∞ –≤ –Ω–æ—Ä–º–µ: ${JS_SIZE}KB"
    fi
fi

echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã..."
IMPORTANT_FILES=("src/pages/Index.tsx" "src/pages/Review.tsx" "src/pages/Profile.tsx" "src/components/CitySelectorSimple.tsx")
for file in "${IMPORTANT_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "‚úÖ $file —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    else
        echo "‚ùå $file –Ω–µ –Ω–∞–π–¥–µ–Ω"
        ERRORS=$((ERRORS + 1))
    fi
done

echo ""
echo "============================================"

if [ $ERRORS -eq 0 ]; then
    echo "üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! –ú–æ–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å."
    echo ""
    echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
    echo "1. git add ."
    echo "2. git commit -m '–≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'"
    echo "3. git push origin main"
    echo "4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–ø–ª–æ–π –Ω–∞ Netlify"
    echo ""
    echo "üåê –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω: https://hachapurimariko.netlify.app"
else
    echo "‚ùå –ù–∞–π–¥–µ–Ω–æ $ERRORS –æ—à–∏–±–æ–∫. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º."
    exit 1
fi 