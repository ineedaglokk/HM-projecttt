#!/bin/bash

# üìä –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ç—É–Ω–Ω–µ–ª—è –∏ –±–æ—Ç–∞

SERVER="root@85.198.83.72"

echo "üîç === –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´ –•–ê–ß–ê–ü–£–†–ò –ú–ê–†–ò–ö–û ==="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üìä PM2 –ü—Ä–æ—Ü–µ—Å—Å—ã:"
ssh $SERVER "pm2 list"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π URL —Ç—É–Ω–Ω–µ–ª—è
echo "üåê –¢–µ–∫—É—â–∏–π URL —Ç—É–Ω–Ω–µ–ª—è:"
TUNNEL_URL=$(ssh $SERVER "grep 'https://.*trycloudflare.com' /tmp/cloudflared.log 2>/dev/null | tail -1 | grep -o 'https://[^[:space:]]*' || echo '–ù–µ –Ω–∞–π–¥–µ–Ω'")
echo "   $TUNNEL_URL"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –≤ –±–æ—Ç–µ
echo "ü§ñ URL –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞:"
BOT_URL=$(ssh $SERVER "grep 'WEBAPP_URL=' ~/hachapuri-bot/.env 2>/dev/null | cut -d'=' -f2 || echo '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'")
echo "   $BOT_URL"
echo ""

# –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º URL
if [ "$TUNNEL_URL" != "–ù–µ –Ω–∞–π–¥–µ–Ω" ] && [ "$BOT_URL" != "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω" ]; then
    if [ "$TUNNEL_URL" = "$BOT_URL" ]; then
        echo "‚úÖ URL —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
    else
        echo "‚ö†Ô∏è  URL –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã!"
        echo "   –¢—É–Ω–Ω–µ–ª—å: $TUNNEL_URL"
        echo "   –ë–æ—Ç:     $BOT_URL"
    fi
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é"
fi
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
ssh $SERVER "tail -5 /tmp/tunnel-monitor.log 2>/dev/null || echo '–õ–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –±–æ—Ç–∞
echo "ü§ñ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –±–æ—Ç–∞:"
ssh $SERVER "pm2 logs hachapuri-bot --lines 3 --nostream 2>/dev/null || echo '–õ–æ–≥–∏ –±–æ—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã'"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if [ "$TUNNEL_URL" != "–ù–µ –Ω–∞–π–¥–µ–Ω" ]; then
    echo "üåç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    if curl -s --head "$TUNNEL_URL" | head -n 1 | grep -q "200 OK"; then
        echo "‚úÖ –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ"
    else
        echo "‚ùå –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
    fi
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–Ω–µ—Ç URL)"
fi

echo ""
echo "=== –ö–û–ù–ï–¶ –û–¢–ß–ï–¢–ê ===" 