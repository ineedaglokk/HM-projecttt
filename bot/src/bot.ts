import { Bot, Context, InlineKeyboard, webhookCallback } from "grammy";
import express from "express";
import dotenv from "dotenv";

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

const BOT_TOKEN = process.env.BOT_TOKEN;
const WEBAPP_URL = process.env.WEBAPP_URL || "https://your-domain.com";
const PORT = parseInt(process.env.PORT || "3000");
const WEBHOOK_URL = process.env.WEBHOOK_URL;

if (!BOT_TOKEN) {
  throw new Error("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!");
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
const bot = new Bot(BOT_TOKEN);

// –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π
interface BotContext extends Context {
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
}

// –ö–æ–º–∞–Ω–¥–∞ /start - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∑–∞–ø—É—Å–∫ Mini App
bot.command("start", async (ctx: BotContext) => {
  const user = ctx.from;
  const firstName = user?.first_name || "–¥—Ä—É–≥";
  
  // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Mini App
  const keyboard = new InlineKeyboard()
    .webApp("üçΩÔ∏è –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", WEBAPP_URL);

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  await ctx.reply(
    `üá¨üá™ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ *–•–∞—á–∞–ø—É—Ä–∏ –ú–∞—Ä–∏–∫–æ*, ${firstName}!

üî• –ú—ã —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å –≤ –Ω–∞—à–µ–π —Å–µ–º—å–µ –≥—Ä—É–∑–∏–Ω—Å–∫–æ–π –∫—É—Ö–Ω–∏!

–í –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤—ã –º–æ–∂–µ—Ç–µ:
‚Ä¢ üìã –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–∏–∫
‚Ä¢ üéÅ –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∞–∫—Ü–∏—è—Ö  
‚Ä¢ üí≥ –ù–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –±–æ–Ω—É—Å—ã
‚Ä¢ ‚≠ê –û—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤—ã
‚Ä¢ üìç –ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
‚Ä¢ üöÄ –ó–∞–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏!`,
    {
      parse_mode: "Markdown",
      reply_markup: keyboard,
    }
  );
});

// –ö–æ–º–∞–Ω–¥–∞ /help - —Å–ø—Ä–∞–≤–∫–∞
bot.command("help", async (ctx: BotContext) => {
  const keyboard = new InlineKeyboard()
    .webApp("üçΩÔ∏è –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", WEBAPP_URL);

  await ctx.reply(
    `üÜò *–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É –•–∞—á–∞–ø—É—Ä–∏ –ú–∞—Ä–∏–∫–æ*

üì± *–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/start - –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
/restaurants - –ù–∞—à–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã
/contact - –ö–æ–Ω—Ç–∞–∫—Ç—ã

üéØ *–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:*
‚Ä¢ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∏–∫–æ–≤
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
‚Ä¢ –ê–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏
‚Ä¢ –û—Ç–∑—ã–≤—ã –∏ —Ä–µ–π—Ç–∏–Ω–≥–∏
‚Ä¢ –î–æ—Å—Ç–∞–≤–∫–∞ –∏ —Å–∞–º–æ–≤—ã–≤–æ–∑

üí° *–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?*
–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.`,
    {
      parse_mode: "Markdown",
      reply_markup: keyboard,
    }
  );
});

// –ö–æ–º–∞–Ω–¥–∞ /restaurants - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö
bot.command("restaurants", async (ctx: BotContext) => {
  const keyboard = new InlineKeyboard()
    .webApp("üìç –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã", WEBAPP_URL + "/restaurants");

  await ctx.reply(
    `üè™ *–ù–∞—à–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –≤ –†–æ—Å—Å–∏–∏:*

üåü *25+ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –≤ –≥–æ—Ä–æ–¥–∞—Ö:*
‚Ä¢ –ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥ (3 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞)
‚Ä¢ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ (4 —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞)
‚Ä¢ –ö–∞–∑–∞–Ω—å, –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫, –£—Ñ–∞
‚Ä¢ –ö–µ–º–µ—Ä–æ–≤–æ, –¢–æ–º—Å–∫, –í–æ–ª–≥–æ–≥—Ä–∞–¥
‚Ä¢ –ò –º–Ω–æ–≥–∏–µ –¥—Ä—É–≥–∏–µ –≥–æ—Ä–æ–¥–∞!

üìç –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤—ã –Ω–∞–π–¥–µ—Ç–µ:
‚Ä¢ –¢–æ—á–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã
‚Ä¢ –ö–∞—Ä—Ç—ã –ø—Ä–æ–µ–∑–¥–∞
‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞—Ä–∫–æ–≤–∫–µ
‚Ä¢ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞:`,
    {
      parse_mode: "Markdown",
      reply_markup: keyboard,
    }
  );
});

// –ö–æ–º–∞–Ω–¥–∞ /contact - –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
bot.command("contact", async (ctx: BotContext) => {
  const keyboard = new InlineKeyboard()
    .webApp("üçΩÔ∏è –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", WEBAPP_URL)
    .row()
    .url("üåê –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç", "https://vhachapuri.ru")
    .row()
    .url("ü§ù –§—Ä–∞–Ω—à–∏–∑–∞", "https://vhachapuri.ru/franshiza");

  await ctx.reply(
    `üìû *–ö–æ–Ω—Ç–∞–∫—Ç—ã –•–∞—á–∞–ø—É—Ä–∏ –ú–∞—Ä–∏–∫–æ*

üåê –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç: vhachapuri.ru
üìß Email: info@vhachapuri.ru
üì± Telegram: @khachapuri_mariko_bot

üè¢ *–ì–æ–ª–æ–≤–Ω–æ–π –æ—Ñ–∏—Å:*
–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥
—É–ª. –†–æ–∂–¥–µ—Å—Ç–≤–µ–Ω—Å–∫–∞—è, 39

ü§ù *–§—Ä–∞–Ω—à–∏–∑–∞:*
–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω—ã –≤ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞?
–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ: vhachapuri.ru/franshiza

üíº *–í–∞–∫–∞–Ω—Å–∏–∏:*
–ò—â–µ–º —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤!
–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–∞ hh.ru`,
    {
      parse_mode: "Markdown",
      reply_markup: keyboard,
    }
  );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on("message", async (ctx: BotContext) => {
  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–µ –∫–æ–º–∞–Ω–¥—É, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  const keyboard = new InlineKeyboard()
    .webApp("üçΩÔ∏è –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", WEBAPP_URL);

  await ctx.reply(
    `–°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ! üòä

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∏–∂–µ –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–∞–º–∏:

/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/restaurants - –ù–∞—à–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã  
/help - –°–ø—Ä–∞–≤–∫–∞
/contact - –ö–æ–Ω—Ç–∞–∫—Ç—ã`,
    {
      reply_markup: keyboard,
    }
  );
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.catch((err) => {
  console.error(`–û—à–∏–±–∫–∞ –±–æ—Ç–∞:`, err);
});

// –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
async function startBot() {
  try {
    console.log("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –•–∞—á–∞–ø—É—Ä–∏ –ú–∞—Ä–∏–∫–æ...");
    
    if (WEBHOOK_URL) {
      // –†–µ–∂–∏–º webhook –¥–ª—è production
      console.log("üì° –†–µ–∂–∏–º: Webhook");
      console.log(`üîó Webhook URL: ${WEBHOOK_URL}`);
      
      const app = express();
      app.use(express.json());
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º webhook
      await bot.api.setWebhook(WEBHOOK_URL);
      
      // –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è webhook
      app.use(webhookCallback(bot, "express"));
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–µ—Ä–∞
      app.get("/health", (req, res) => {
        res.json({ status: "OK", timestamp: new Date().toISOString() });
      });
      
      app.listen(PORT, () => {
        console.log(`‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
        console.log(`üåê Webhook –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: ${WEBHOOK_URL}`);
      });
      
    } else {
      // –†–µ–∂–∏–º polling –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
      console.log("üîÑ –†–µ–∂–∏–º: Polling (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)");
      await bot.start();
    }
    
    console.log("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!");
    console.log(`üîó Mini App URL: ${WEBAPP_URL}`);
    
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:", error);
    process.exit(1);
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown
process.once("SIGINT", () => {
  console.log("üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGINT, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...");
  bot.stop();
});

process.once("SIGTERM", () => {
  console.log("üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGTERM, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...");
  bot.stop();
});

// –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
startBot(); 